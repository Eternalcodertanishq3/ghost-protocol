version: '3.8'

services:
  # HashiCorp Vault for key management
  vault:
    image: hashicorp/vault:latest
    container_name: ghost-vault
    ports:
      - "8200:8200"
    environment:
      - VAULT_DEV_ROOT_TOKEN_ID=ghost-root-token
      - VAULT_DEV_LISTEN_ADDRESS=0.0.0.0:8200
    volumes:
      - vault-data:/vault/data
    networks:
      - ghost-net
    cap_add:
      - IPC_LOCK

  # Redis for caching and pub/sub
  redis:
    image: redis:7-alpine
    container_name: ghost-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - ghost-net
    command: redis-server --appendonly yes

  # PostgreSQL for persistent data storage
  postgres:
    image: postgres:15-alpine
    container_name: ghost-postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=ghost_protocol
      - POSTGRES_USER=ghost_user
      - POSTGRES_PASSWORD=ghost_password
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - ghost-net

  # Secure National Aggregator (SNA) - Main Service
  sna:
    build:
      context: .
      dockerfile: Dockerfile.sna
    container_name: ghost-sna
    ports:
      - "8000:8000"
    environment:
      - VAULT_ADDR=http://vault:8200
      - VAULT_TOKEN=ghost-root-token
      - REDIS_URL=redis://redis:6379
      - POSTGRES_URL=postgresql://ghost_user:ghost_password@postgres:5432/ghost_protocol
      - SNA_HOST=0.0.0.0
      - SNA_PORT=8000
      - BYZANTINE_TOLERANCE=0.33
      - MAX_EPSILON=9.5
      - DELTA=1e-6
    volumes:
      - ./sna:/app/sna
      - sna-models:/app/models
      - ./logs:/app/logs
    networks:
      - ghost-net
    depends_on:
      - vault
      - redis
      - postgres
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # SHAP Explainer Service
  shap-explainer:
    build:
      context: .
      dockerfile: Dockerfile.shap
    container_name: ghost-shap-explainer
    ports:
      - "8001:8001"
    environment:
      - REDIS_URL=redis://redis:6379
      - POSTGRES_URL=postgresql://ghost_user:ghost_password@postgres:5432/ghost_protocol
      - SHAP_HOST=0.0.0.0
      - SHAP_PORT=8001
      - BYZANTINE_TOLERANCE=0.33
      - PRIVACY_EPSILON=1.0
    volumes:
      - ./sna/shap_explainer:/app/shap_explainer
      - ./logs:/app/logs
    networks:
      - ghost-net
    depends_on:
      - redis
      - postgres
    restart: unless-stopped

  # Compliance Heartbeat Service
  compliance-heartbeat:
    build:
      context: .
      dockerfile: Dockerfile.compliance
    container_name: ghost-compliance-heartbeat
    ports:
      - "8002:8002"
    environment:
      - REDIS_URL=redis://redis:6379
      - POSTGRES_URL=postgresql://ghost_user:ghost_password@postgres:5432/ghost_protocol
      - HEARTBEAT_HOST=0.0.0.0
      - HEARTBEAT_PORT=8002
      - BYZANTINE_TOLERANCE=0.33
      - HEARTBEAT_INTERVAL=60
    volumes:
      - ./sna/compliance_heartbeat:/app/compliance_heartbeat
      - ./logs:/app/logs
    networks:
      - ghost-net
    depends_on:
      - redis
      - postgres
    restart: unless-stopped

  # Drift Incentivizer Service
  drift-incentivizer:
    build:
      context: .
      dockerfile: Dockerfile.drift
    container_name: ghost-drift-incentivizer
    ports:
      - "8003:8003"
    environment:
      - REDIS_URL=redis://redis:6379
      - POSTGRES_URL=postgresql://ghost_user:ghost_password@postgres:5432/ghost_protocol
      - DRIFT_HOST=0.0.0.0
      - DRIFT_PORT=8003
      - INCENTIVE_POOL_SIZE=100000
    volumes:
      - ./sna/drift_incentivizer:/app/drift_incentivizer
      - ./logs:/app/logs
    networks:
      - ghost-net
    depends_on:
      - redis
      - postgres
    restart: unless-stopped

  # Dropout Predictor Service
  dropout-predictor:
    build:
      context: .
      dockerfile: Dockerfile.dropout
    container_name: ghost-dropout-predictor
    ports:
      - "8004:8004"
    environment:
      - REDIS_URL=redis://redis:6379
      - POSTGRES_URL=postgresql://ghost_user:ghost_password@postgres:5432/ghost_protocol
      - DROPOUT_HOST=0.0.0.0
      - DROPOUT_PORT=8004
      - PREDICTION_HORIZON_HOURS=24
    volumes:
      - ./sna/dropout_predictor:/app/dropout_predictor
      - ./logs:/app/logs
    networks:
      - ghost-net
    depends_on:
      - redis
      - postgres
    restart: unless-stopped

  # Adaptive Clustering Service
  adaptive-clustering:
    build:
      context: .
      dockerfile: Dockerfile.clustering
    container_name: ghost-adaptive-clustering
    ports:
      - "8005:8005"
    environment:
      - REDIS_URL=redis://redis:6379
      - POSTGRES_URL=postgresql://ghost_user:ghost_password@postgres:5432/ghost_protocol
      - CLUSTERING_HOST=0.0.0.0
      - CLUSTERING_PORT=8005
      - MAX_CLUSTERS=10
      - MIN_CLUSTER_SIZE=5
    volumes:
      - ./sna/adaptive_clustering:/app/adaptive_clustering
      - ./logs:/app/logs
    networks:
      - ghost-net
    depends_on:
      - redis
      - postgres
    restart: unless-stopped

  # Dispute Resolution Service
  dispute-resolution:
    build:
      context: .
      dockerfile: Dockerfile.dispute
    container_name: ghost-dispute-resolution
    ports:
      - "8006:8006"
    environment:
      - REDIS_URL=redis://redis:6379
      - POSTGRES_URL=postgresql://ghost_user:ghost_password@postgres:5432/ghost_protocol
      - DISPUTE_HOST=0.0.0.0
      - DISPUTE_PORT=8006
      - BYZANTINE_TOLERANCE=0.33
      - VOTING_TIMEOUT=30
    volumes:
      - ./sna/dispute_resolution:/app/dispute_resolution
      - ./logs:/app/logs
    networks:
      - ghost-net
    depends_on:
      - redis
      - postgres
    restart: unless-stopped

  # Synthetic Gateway Service
  synthetic-gateway:
    build:
      context: .
      dockerfile: Dockerfile.synthetic
    container_name: ghost-synthetic-gateway
    ports:
      - "8007:8007"
    environment:
      - REDIS_URL=redis://redis:6379
      - POSTGRES_URL=postgresql://ghost_user:ghost_password@postgres:5432/ghost_protocol
      - SYNTHETIC_HOST=0.0.0.0
      - SYNTHETIC_PORT=8007
      - DEFAULT_PRIVACY_EPSILON=1.0
      - DEFAULT_DELTA=1e-6
    volumes:
      - ./sna/synthetic_gateway:/app/synthetic_gateway
      - ./logs:/app/logs
    networks:
      - ghost-net
    depends_on:
      - redis
      - postgres
    restart: unless-stopped

  # Model Marketplace Service
  model-marketplace:
    build:
      context: .
      dockerfile: Dockerfile.marketplace
    container_name: ghost-model-marketplace
    ports:
      - "8008:8008"
    environment:
      - REDIS_URL=redis://redis:6379
      - POSTGRES_URL=postgresql://ghost_user:ghost_password@postgres:5432/ghost_protocol
      - MARKETPLACE_HOST=0.0.0.0
      - MARKETPLACE_PORT=8008
      - BYZANTINE_TOLERANCE=0.33
      - MIN_PEER_VALIDATIONS=5
    volumes:
      - ./sna/model_marketplace:/app/model_marketplace
      - ./logs:/app/logs
    networks:
      - ghost-net
    depends_on:
      - redis
      - postgres
    restart: unless-stopped

  # Quantum Vault Service
  quantum-vault:
    build:
      context: .
      dockerfile: Dockerfile.quantum
    container_name: ghost-quantum-vault
    ports:
      - "8009:8009"
    environment:
      - REDIS_URL=redis://redis:6379
      - POSTGRES_URL=postgresql://ghost_user:ghost_password@postgres:5432/ghost_protocol
      - QUANTUM_HOST=0.0.0.0
      - QUANTUM_PORT=8009
      - DEFAULT_SECURITY_LEVEL=5
      - KEY_ROTATION_DAYS=90
    volumes:
      - ./sna/quantum_vault:/app/quantum_vault
      - ./logs:/app/logs
    networks:
      - ghost-net
    depends_on:
      - redis
      - postgres
    restart: unless-stopped

  # Ghost Agents (hospital side) - scalable
  ghost-agent:
    build:
      context: .
      dockerfile: Dockerfile.agent
    ports:
      - "8100-8199:8100"
    environment:
      - VAULT_ADDR=http://vault:8200
      - VAULT_TOKEN=ghost-root-token
      - SNA_URL=http://sna:8000
      - REDIS_URL=redis://redis:6379
      - AGENT_HOST=0.0.0.0
      - AGENT_PORT=8100
      - PRIVACY_EPSILON=1.23
      - DELTA=1e-6
      - BYZANTINE_TOLERANCE=0.33
    volumes:
      - ./ghost_agent:/app/ghost_agent
      - ./data:/app/data
      - ./logs:/app/logs
    networks:
      - ghost-net
    depends_on:
      - sna
      - vault
      - redis
      - postgres
    deploy:
      replicas: 10
    restart: unless-stopped

  # Frontend Dashboard
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: ghost-frontend
    ports:
      - "3000:3000"
    environment:
      - REACT_APP_SNA_URL=http://localhost:8000
      - REACT_APP_WS_URL=ws://localhost:8000
      - REACT_APP_SHAP_URL=http://localhost:8001
      - REACT_APP_COMPLIANCE_URL=http://localhost:8002
      - REACT_APP_DRIFT_URL=http://localhost:8003
      - REACT_APP_DROPOUT_URL=http://localhost:8004
      - REACT_APP_CLUSTERING_URL=http://localhost:8005
      - REACT_APP_DISPUTE_URL=http://localhost:8006
      - REACT_APP_SYNTHETIC_URL=http://localhost:8007
      - REACT_APP_MARKETPLACE_URL=http://localhost:8008
      - REACT_APP_QUANTUM_URL=http://localhost:8009
    volumes:
      - ./frontend:/app
      - /app/node_modules
    networks:
      - ghost-net
    depends_on:
      - sna
      - shap-explainer
      - compliance-heartbeat
      - drift-incentivizer
      - dropout-predictor
      - adaptive-clustering
      - dispute-resolution
      - synthetic-gateway
      - model-marketplace
      - quantum-vault
    restart: unless-stopped

  # Nginx Load Balancer
  nginx:
    image: nginx:alpine
    container_name: ghost-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    networks:
      - ghost-net
    depends_on:
      - frontend
      - sna
    restart: unless-stopped

  # Monitoring - Prometheus
  prometheus:
    image: prom/prometheus:latest
    container_name: ghost-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    networks:
      - ghost-net
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'

  # Monitoring - Grafana
  grafana:
    image: grafana/grafana:latest
    container_name: ghost-grafana
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=ghost-admin
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./grafana/datasources:/etc/grafana/provisioning/datasources
    networks:
      - ghost-net

  # Log Aggregation - ELK Stack
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: ghost-elasticsearch
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - xpack.security.enabled=false
    ports:
      - "9200:9200"
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
    networks:
      - ghost-net

  logstash:
    image: docker.elastic.co/logstash/logstash:8.11.0
    container_name: ghost-logstash
    ports:
      - "5000:5000"
    volumes:
      - ./logstash.conf:/usr/share/logstash/pipeline/logstash.conf
    networks:
      - ghost-net
    depends_on:
      - elasticsearch

  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.0
    container_name: ghost-kibana
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    networks:
      - ghost-net
    depends_on:
      - elasticsearch

networks:
  ghost-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  vault-data:
  redis-data:
  postgres-data:
  sna-models:
  prometheus-data:
  grafana-data:
  elasticsearch-data: